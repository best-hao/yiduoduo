@{
    Layout = null;
}
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta content="telephone=no" name="format-detection">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>付款-@(WorkContext.SellerInfo.SellerName)</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="stylesheet" type="text/css" href="/Mobile/Themes/huadong/static/weui/style/weui.css" />
    <link rel="stylesheet" type="text/css" href="/Mobile/Themes/huadong/static/weui/style/weui2.css" />
    <script src="/Mobile/Themes/huadong/static/weui/zepto.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="/Mobile/Themes/huadong/static/weui/ydui.flexible.js" type="text/javascript" charset="utf-8"></script>
    <script src="/Js/vue/dist/vue.min.js" type="text/javascript" charset="utf-8"></script> 
    <script src="/Js/Mobile/md5.js" type="text/javascript"></script>
    <style type="text/css">
    	body{background: #f6f6f6;width: 7.5rem;margin: 0 auto;max-width: 480px;}
    	body *{max-width: 480px;}
		.weui-header{background: #fff;color: #666;font-size: 0.28rem;font-family: "微软雅黑";position:fixed;top:0;width:7.5rem;margin:0 auto;z-index: 10;}
		.weui-header a{color: #666;}
		.weui-header .weui-header-left a{color: #666;}
		.weui-header .weui-header-title, .weui-header h1{color: #666;}
		.main{font-size: 0.24rem;font-family: "微软雅黑";position:relative;top:15%;}
		.card-box{background: #fff;border-radius: 10px;height: 9.6rem;position: relative; margin: 0rem 0.2rem 0.2rem 0.2rem;-moz-box-shadow:1px 1px 10px #d9d9d9; -webkit-box-shadow:1px 1px 10px #d9d9d9; box-shadow:1px 1px 10px #d9d9d9;}
		.card-bottom{position: absolute;width: 6.5rem;left: 0.3rem;top: 1.9rem;}
		.infos-box{position: absolute;top: -.6rem;width: 100%;}
		.infos-box img{width: 1.6rem;height: 1.6rem;border-radius: 50%;display: block;margin: 0 auto;}
		.infos-box p{height: 0.6rem;line-height: 0.6rem;text-align: center;}
		.infos-box .btn{width: 1.5rem;height: 0.56rem;line-height: 0.56rem;text-align: center;color: #fff;background: #e4393c;margin: 0 auto;border-radius: 15px;}
		.pay-infos{}
		.pay-infos .title{height: 0.6rem;line-height: 0.6rem;color: #333;font-size: 0.32rem;}
		.pay-infos .input-box{font-size: 0.36rem;color: #000;position: relative;height: 1rem;line-height: 1rem;margin: 0.2rem 0;}
		#money{height: 1rem;line-height: 1rem;border: none;outline: none;width: 5.3rem;padding-left: 0.6rem;font-size: 0.6rem;text-align: center;}
		.pay-infos .input-box:before{content: "¥";position: absolute;top: 0;left: 0;font-size: 0.6rem;}
		.pay-infos .input-box:after{content: "";position: absolute;bottom: 0;left: 0;height: 1px;width:100%;background: #d9d9d9;}
		.get-score-info{line-height: 0.6rem;}
		.get-score-info .lt{color: #999;}
		.get-score-info .rt{}
		.confirm{display:block;width: 6.5rem;margin: 0.3rem auto 0 auto;height: 0.8rem;line-height: 0.8rem;background:  #e4393c;color: #fff;text-align: center;border-radius: 5px;font-size: 0.32rem;}
		.confirm:active{opacity: 0.7;color: #fff;}
		
		body{background:#F7F7F7}
		.bg-white{background:#fff}
		.color_gray{color:#8C8C8C}
		.joinpay_list{background:#fff}
		.Payment{margin:10px 0;background:#fff;box-sizing:border-box}
		.joinpay_list .weui_cell:before{border-top:0;padding:0!important;margin:0!important;left:0!important}
		.joinpay_thumb i{font-size:30px;color:#e4393c;margin-right:10px;box-sizing:border-box}
		.sw_right{float:right}
		.chose_list{background:#fff;padding:0 12px;box-sizing:border-box}
		.chose_list .weui-flex{align-items:center;padding:6px 0;border-bottom:1px solid #E8E8E8}
		.chose_list .weui-flex:last-child{border-bottom:none}
		.chose_list .weui-flex .weui-flex-item span{font-size:14px;color:#8C8C8C}
		.now_payment{background:#fff;width:100%;text-align:center;margin-top:10px;padding:15px 0}
		.now_payment button{border:0;outline:0;width:80%;height:35px;line-height:35px;text-align:center;border-radius:35px;background:#E02E24;color:#fff;font-size:16px;margin:0 auto}
		.weui_cell{padding:4px 15px}
		.red-money{color:#E02E24;font-weight:600}
		.disabled{background:#f2f2f2;color:#999}
		.appclass{position:relative;top:15%;display:none}
		.weui_dialog_hd{padding:0!important}
		.weui_toast{width:3rem;min-height:3rem;left:31%;top:35%;margin-left:0}
		.password-shade{display: none;position: fixed;width: 7.5rem;top: 0;left: 50%;margin-left: -3.75rem;height: 100%;z-index: 20;background: rgba(0,0,0,0.5);}
		.password-box{position: absolute;border-radius: 5px; z-index: 21;width: 6.5rem;height: 4rem;bottom: 50%;margin-bottom: -2rem;left: 0.5rem;right: 0.5rem;background: #fff;font-size: 0.32rem;}
		.password-box .title{position: relative;height: 0.8rem;line-height: 0.8rem;text-align: center;padding: 0 0.2rem;border-bottom: 1px solid #f2f2f2;}
		.close-password{position: absolute;width: 0.6rem;height: 0.6rem;line-height: 0.6rem;top: 0;right: 0.2rem;vertical-align: middle;color: #f00;}
		.close-password .icon{font-size: 0.4rem;vertical-align: middle;text-align: center;}
		.pass-input{padding: 1rem 0.3rem;}
		.password-box .input-box{width: 5.9rem;}
		.password-box .box{position: relative;width: 5.9rem;position: relative;height: 0.8rem;line-height: 0.8rem;z-index: 21;}
		.password-box .input-box .weui-flex{width: 5.9rem;height: 0.8rem;line-height: 0.8rem;}
		.password-box .weui-flex .weui-flex-item{width: 0.8rem;border: 1px solid #d9d9d9;text-align: center;}
		.password-box .password{width: 5.9rem;top: 0;left: 0;height: 0.8rem;line-height: 0.8rem;border: 0;outline: 0;position: absolute;opacity: 0;}
		input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill{background: #fff !important;}
		.weui-flex-item div{height: 0.8rem;line-height: 0.94rem;font-size: 0.4rem;}
		.weui_toast{font-size: 0.32rem;}
		.password-box .password {
	    top: -1rem;
	    height: 1.8rem;
	    line-height: 1.8rem;
	}
	.pass-input{padding-bottom: 0;}
	.forgetpwd{text-align: right;color: #00BFFF;padding: 0.1rem 0.3rem;}
	.alipaycr{color:#56abe4!important}
	.weixincr{color:#09bb07!important}
    </style>
</head>
<body>
	<div id='shoppay' class='appclass' >
		
	
	 	<div class="weui-header"> 
			<div class="weui-header-left"> <a href="javascript:history.back()" class="icon icon-109"></a>  </div>
			<h1 class="weui-header-title shopname" v-text='shopInfo.shopname'></h1>
			<div class="weui-header-right"></div> 
	    </div>
	    <div class="main">
	    	<div class="card-box">
	    		<div class="infos-box">
	    			<img  class='logo' v-if="shopInfo.logo" :src="'@(WorkContext.ShopConfig.ImageCDN)'+shopInfo.logo" />
	    			<img class='logo' v-else src=""/>
	    			<p class='shopname'v-text=''>{{shopInfo.shopname}}</p>
	    			<div class="btn profits-btn">让利{{shopInfo.profits}}%</div>
	    		</div>
	    		<div class="card-bottom">
	        		<div class="pay-infos">
	        			<div class="title">消费金额</div>
	        			<div class="input-box">
	        				<input type="tel" name="money"  id="money1"  placeholder="请输入金额" style="display: none;" />
	        				<input type="text" name="money"  autocomplete="off" id="money" v-model="money" placeholder="请输入金额"  />
	        			</div>
	        			<div class="get-score-info">
	        				<div class="weui-flex">
	        					<div class="weui-flex-item lt">可得积分说明</div>
	        					<div class="weui-flex-item rt tright">赠送<span>{{Number(Number(money)*(shopInfo.profits/100)*5).toFixed(3)}}</span>积分</div>
	        				</div>
	        			</div>
	        		</div>
	        		<!--支付方式start-->
	        		<div class="chose_payment">
						<div class="chose_list">
							<!--div class="weui-flex">
								<div class="joinpay_thumb">
									<i class="icon icon-42"></i>
								</div>
								<div class="weui-flex-item">
									<p>红包支付</p>
									<span>红包余额@(WorkContext.UserInfo.UserMoney)</span>
								</div>
								<div class="sw_toggle">
									<div class="sw_right sw-hb">
				                    	<input class="weui_switch weui-hongbao" id="redpackt" data-id="1" type="checkbox" v-on:click="checkPay(1)" />
				                	</div>
								</div>
							</div-->
							<div class="weui-flex">
								<div class="joinpay_thumb">
									<i class="icon icon-11 alipaycr"></i>
								</div>
								<div class="weui-flex-item">
									<p>支付宝</p>
									<span>红包抵现，方便快捷</span>
								</div>
								<div class="sw_toggle">
									<div class="sw_right">
				                    	<input class="weui_switch weui-wx weui-zf" id="apliy" data-id="2"  type="checkbox" v-on:click="checkPay(2)" />
				                	</div>
								</div>
							</div>
						
							@if (Yitao.Core.WebHelper.IsWeiXin())
        					{
								<div class="weui-flex">
									<div class="joinpay_thumb">
										<i class="icon icon-14 weixincr"></i>
									</div>
									<div class="weui-flex-item">
										<p>微信支付</p>
										<span>红包抵现，方便快捷</span>
									</div>
									<div class="sw_toggle">
										<div class="sw_right">
					                    	<input class="weui_switch weui-wx weui-weixin1" id="weixin" data-id="3" type="checkbox" v-on:click="checkPay(3)" />
					                	</div>
									</div>
								</div>
							}
						</div>
					</div>
	        		<!--支付方式end-->
			      	<a class="btn confirm" id="payNow" v-on:click="confirmPay()">
			      		<span v-if="payMoney>0">还需支付{{Number(payMoney).toFixed(2)}}</span>
			      		<span v-else>确认支付</span>
			      	</a>
	    		</div>
	    	</div>
	    </div>
	    <div class="password-shade">
		    <div class="password-box">
		    	<div class="title" onclick="closePwd()">
		    		输入密码
		    		<div class="close-password"><span class="icon icon-73"></span></div>
		    	</div>
		    	<div class="pass-input">
		    		<div class="box">
		    			<input type="password" name="password" style="display: none;" />
		    			<input type="number" name="password" class="password" v-model="pwd" />
			    		<div class="input-box">
			    			<div class="weui-flex">
			    				<div class="weui-flex-item"><div v-show="pwd.length>0">*</div></div>
			    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>1">*</div></div>
			    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>2">*</div></div>
			    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>3">*</div></div>
			    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>4">*</div></div>
			    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>5">*</div></div>
			    			</div>
			    		</div>
		    		</div>
		    	</div>
		    	<div class="forgetpwd"><a href="/m/account/resetpaypwd">忘记密码</a></div>
		    </div>
	    </div>
    </div>
	<script>
    var uid = "@WorkContext.Uid";
	var paypwd = "@WorkContext.UserInfo.PayPwd";
	$.showLoading(); 
	var shopid = '@ViewData["ShopId"]'; 
	var payInfo = {};
	var vm = new Vue({
		el: "#shoppay",
		data: {
			userMoney: "@WorkContext.UserInfo.UserMoney",
			money: "",
			shopInfo: [],
			payType: 1,
			score: 0,
			payMoney: 0,
			pwd: "",
			hidepwd: 0,
			curuserid: 0
		},
		created: function() {
			this.getShopInfo();
			$("#shoppay").css("display","block");
			
		},
		methods: {
			getShopInfo: function() {
				var _this = this;
				$.ajax({
					type:"get",
					url:'/Api/Shop/GetShopInfo?ShopId='+shopid,
					async:true,
					success: function(rel) {
						$.hideLoading();
						if(rel.code==1){
							_this.shopInfo = rel.data;
							$.ajax({
								type:"get",
								url:'/Api/Seller/MiniGetSellerInfo?SellerId='+rel.data.sellerid,
								async:true,
								success: function(rel) {
									if(rel.code==1){
										_this.curuserid = rel.data.userid;
									}
								}
							});
						}
					}
				});
			},
			checkPay: function(type) {
				var RedPacktMoney = 0;
				if(Number(vm.money)<=Number(vm.userMoney)){
					RedPacktMoney = Number(vm.money);
				}else{
					RedPacktMoney = Number(vm.userMoney);
				}
				var type = type;
				if($("#redpackt").prop("checked")){
					if(type==2 || type==3){
						if(Number(this.money)>0){
							if(Number(this.money)<=Number(this.userMoney)){
								$("#apliy,#weixin").prop("checked",false);
								$.alert("您的红包余额已经足够支付，快去用红包付款吧");
							}else{
								if(type==2){
									$("#weixin").prop("checked",false);
								}else if(type==3){
									$("#apliy").prop("checked",false);
								}
							}
						}else{
							$("#apliy,#weixin").prop("checked",false);
							$.alert("请先输入正确的金额");
						}
					}else{
						if(Number(this.money)<=Number(this.userMoney)){
							$("#apliy,#weixin").prop("checked",false);
						}
					}
					vm.payMoney = Number(vm.money)-RedPacktMoney;
				}else{
					vm.payMoney = Number(vm.money);
					if(type==2){
						$("#weixin").prop("checked",false);
					}else if(type==3){
						$("#apliy").prop("checked",false);
					}
				}
			},
			confirmPay: function() {
				if(Number(vm.curuserid)==Number(uid)){
                	$.alert("不能给自己门店付款");
                	return false;
                }
				if(Number(this.money)<=0){
					$.alert("请输入金额");
				}else{
					if($(".weui_switch:checked").length<=0){
						$.alert("请选择支付方式");
					}else{
						var redType = $("#redpackt").prop("checked");
						var apliyType = $("#apliy").prop("checked");
						var weixinType = $("#weixin").prop("checked");
						if(redType){
							if($(".weui_switch:checked").length==1){
								//红包支付
								if(Number(vm.money)<=Number(vm.userMoney)){
									redPay();
								}else{
									$.alert("红包余额不足，请再选择一个其他支付方式进行支付");
								}
							}else if($(".weui_switch:checked").length>1){
								//支付宝支付
								if(apliyType){
									apliyPay();
								}
							}
						}else{
							//支付宝支付
							if(apliyType){
								apliyPay();
							}
						}
							
					}
				}
			}
			
		},
		watch:{
	 		money: function(val,oldval) {
	 			/*var str = val.toString();
				var intstr = str;
				if(str.indexOf(".")!=-1){
					intstr = str.split(".")[0];
				}
				if(intstr.length>5){
					this.money = oldval;
				}*/
				//先把非数字的都替换掉，除了数字和.
				this.money = val.replace(/[^\d.]/g,"");
				//必须保证第一个为数字而不是.
				this.money = this.money.replace(/^\./g,"");
				//保证只有出现一个.而没有多个.
				this.money = this.money.replace(/\.{2,}/g,".");
				//保证.只出现一次，而不能出现两次以上
				this.money = this.money.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
				
				
				var str = this.money.toString();
				var intstr = str;
				if(str.indexOf(".")!=-1){
					intstr = str.split(".")[0];
					if(str.split(".")[1].length>2){
						this.money = oldval;
					}
				}
				if(intstr.length>=6){
					if(Number(val)>100000){
						this.money = oldval;
					}
				}
				var RedPacktMoney = 0;
				if(Number(this.money)<=Number(this.userMoney)){
					RedPacktMoney = Number(this.money);
					$("#redpackt").prop("checked",true);
					$("#apliy,#weixin").prop("checked",false);
				}else{
					$("#apliy").prop("checked",true);
					RedPacktMoney = Number(this.userMoney);
				}
				if(this.money!=""){
					
					this.payMoney = Number(this.money)-RedPacktMoney;
				}
	 		},
	 		pwd: function(val,oldval) {
	 			if(val.length>6){
	 				this.pwd = oldval;
	 			}else{
	 				if(this.pwd.length==6){
	 					
	 					var cur_pwd = this.pwd+"@WorkContext.UserInfo.PaySalt";
	 					cur_pwd = hex_md5(cur_pwd);
	 					if(paypwd==cur_pwd){
	 						$(".password-shade").hide();
	 						finalRedPay();
	 					}else{
	 						this.pwd="";
	 						$.toast("密码错误","cancel");
	 					}
	 				}
	 			}
	 		}
	    }
		
		
	});
	function closePwd() {
		$(".password-shade").hide();
	}
	function finalRedPay() {
		isPay=1;
		var RedPacket = 0;
		if(Number(vm.money)<=Number(vm.userMoney)){
			RedPacket = vm.money;
			var data={ payType:1,PayAmount:$("#money").val(),ShopId:shopid,RedPacket:RedPacket}
		 	$.ajax({
		 		type: 'post',
		 		url: 'shoppay',
		 		data: data,
		 		dataType: 'json',
		 		success: function(data){
		 			if(data.Code==1){
						window.location.href='/m/settlement/payresult?orderid=' + data.Data;
		 			}else{
		 				$.alert(data.Message);
		 			}
		 		},
		 		error: function(xhr,type){
		 			console.log(xhr);
		 			$.alert(JSON.stringify(xhr),function(){});
		 		}
		 	});
		}else{
			$.alert("红包余额不足，请选择其他支付方式");
		}
		setTimeout(function(){
			isPay = 0;
		},2000);
	}
	var isPay = 0;
	//红包支付
	function redPay() {
		if(paypwd==""){
			if(isPay==0){
				finalRedPay();
			}
		}else{
			
			//弹出密码框
			$(".password-shade").show();
			$(".password").focus();
			/*if(vm.pwd=="" || vm.pwd.length<=0){
				$.alert("请输入密码");
			}else{
				
			}*/
		}
		
	}
	//用支付宝支付
	function apliyPay() {
		var RedPacket = 0;
		if($("#redpackt").prop("checked")){
			if(Number(vm.money)<=Number(vm.userMoney)){
				RedPacket = vm.money;
			}else{
				RedPacket = vm.userMoney;
			}
		}else{
			RedPacket = 0;
		}
		var url='/m/settlement/ShopAlipay?payType=2'+'&PayAmount='+$("#money").val()+'&ShopId='+shopid+'&RedPacket='+RedPacket;
	    window.location.href =url ;
	}
	//用微信支付
	function wxPay() {
		var RedPacket = 0;
		if($("#redpackt").prop("checked")){
			if(Number(vm.money)<=Number(vm.userMoney)){
				RedPacket = vm.money;
			}else{
				RedPacket = vm.userMoney;
			}
		}else{
			RedPacket = 0;
		}
		var data={payType:3,PayAmount:$("#money").val(),ShopId:shopid,RedPacket:RedPacket}
		//$.alert(JSON.stringify(data));
		//return false;
		$.ajax({
    		type:"post",
    		url:"shoppay",
    		async:true,
    		data:data,
    		dataType:"json",
    		success:function(rst) {
    			//$.alert(JSON.stringify(rst));
    			
    			if(rst.Code==1){
    				//公众号支付
		            WeixinJSBridge.invoke('getBrandWCPayRequest', {
		                "appId": rst.appId,
		                "timeStamp": rst.timeStamp,
		                "nonceStr": rst.nonceStr,
		                "package": rst.package,
		                "signType": "MD5",
		                "paySign": rst.paySign
		            }, function (res) {
		            	//alert(JSON.stringify(res));
		            	var message=''    							
//					            	
		                if (res.err_msg == "get_brand_wcpay_request:ok") {
		                	message='支付成功'
		                	window.location.href='/m/Settlement/PayResult'
		                } else if(res.err_msg =='get_brand_wcpay_request:cancel'){
							message='支付过程中用户取消'
						}else if(res.err_msg =='get_brand_wcpay_request:fail'){
							message='支付失败'
						} 
	                   $.alert(message);
//					                
		                // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
		                //因此微信团队建议，当收到ok返回时，向商户后台询问是否收到交易成功的通知，若收到通知，前端展示交易成功的界面；若此时未收到通知，商户后台主动调用查询订单接口，查询订单的当前状态，并反馈给前端展示相应的界面。
		            });
		            WeixinJSBridge.log('yo~ ready.');
    			}else{
    				$.alert(rst.Message);
    			}
    			
    		}
    	});
			
	}
	
	
	//weixin选中
    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
		$("#payNow").on("click",function() {
			if(Number(vm.curuserid)==Number(uid)){
            	$.alert("不能给自己门店付款");
            	return false;
            }
			if(Number(vm.money)<=0){
				$.alert("请输入金额");
			}else{
				if($(".weui_switch:checked").length<=0){
					$.alert("请选择支付方式");
				}else{
					var weixinType = $("#weixin").prop("checked");
					if(weixinType){
						wxPay();
					}
						
				}
			}
			
		});
	});
	
	function removeRead() {
		//$("#money").removeAttr("readonly");
		//$("#money").click();
	}
	$(function(){
		/*$("#money").on("input propertychange",function(){
			var num = $(this).val();
			if(isNaN(num)){
				if(isNaN(parseFloat(num))){
					$(this).val("");
					vm.money = "";
				}else{
					if(num!=""){
						$(this).val(parseFloat(num));
						vm.money = parseFloat(num);
					}
				}
			}else{
				if(parseFloat(num)==num.toString()){
					if(num.toString().indexOf(".")>-1){
    					if(num.toString().split(".")[1].length>2){
    						num = num.toString().substring(0,num.toString().split(".")[0].length+3)
    					}
    					$(this).val(num);
    					vm.money = num;
					}
				}else{
					if(num!=""){
						$(this).val(parseFloat(num));
						vm.money = parseFloat(num);
					}
				}
			}
			var RedPacktMoney = 0;
			if(Number(vm.money)<=Number(vm.userMoney)){
				RedPacktMoney = Number(vm.money);
				$("#redpackt").prop("checked",true);
				$("#apliy,#weixin").prop("checked",false);
			}else{
				$("#apliy").prop("checked",true);
				RedPacktMoney = Number(vm.userMoney);
			}
			if(vm.money!=""){
				
				vm.payMoney = Number(vm.money)-RedPacktMoney;
			}
		});
		if($("#money").attr("readonly")=="readonly"){
			$("#money").removeAttr("readonly");
		}*/
		
		//setTimeout(function(){
			//$("#money").removeAttr("readonly");
		//},300);
	})
	/*$.showLoading(); 
	var pay = {};
	pay.payType = 1;
    var shopid=window.location.href.split('=')[1];
	$(document).on('click', ".sw-hb", function () {
        if(@WorkContext.UserInfo.UserMoney==0){
      	  $.alert('红包余额不足',  function () { });
           $(this).find('input').prop("checked",false)
        }
	});
	//weixin选中
    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
        $("#payNow").on("click",function() {
        	var redPacket=0;    
			var Packet=@WorkContext.UserInfo.UserMoney;
			var PayAmount=$('#money').val();
			if($('.weui-hongbao').prop("checked")){
				if($('.weui-weixin1').prop("checked")){
			  		if(Packet>PayAmount){
							redPacket=PayAmount;
							packet(1,PayAmount,redPacket);
						    return false;	
					}else{	
							redPacket=Packet
					}
					 		pay.payType=3
				}
			
		    }else{
	 	        redPacket=0
			 	if($('.weui-zf').prop("checked")){
					pay.payType=2
				}
				if($('.weui-weixin1').prop("checked")){
		 			pay.payType=3
	            }
		    }
    		if(pay.payType==3){                    
                var data={payType:3,PayAmount:$('#money').val(),ShopId:@ViewData["ShopId"],RedPacket:redPacket}
                
        		$.ajax({
	        		type:"post",
	        		url:"shoppay",
	        		async:true,
	        		data:data,
	        		dataType:"json",
	        		success:function(rst) {
	        			if(rst.Code==1){
	        				//公众号支付
				            WeixinJSBridge.invoke('getBrandWCPayRequest', {
				                "appId": rst.appId,
				                "timeStamp": rst.timeStamp,
				                "nonceStr": rst.nonceStr,
				                "package": rst.package,
				                "signType": "MD5",
				                "paySign": rst.paySign
				            }, function (res) {
				            	var message=''    							
//					            	alert(JSON.stringify(res))
				                if (res.err_msg == "get_brand_wcpay_request:ok") {
				                	message='支付成功'
				                	window.location.href='/m/Settlement/PayResult'
				                } else if(res.err_msg =='get_brand_wcpay_request:cancel'){
    								message='支付过程中用户取消'
    							}else if(res.err_msg =='get_brand_wcpay_request:fail'){
    								message='支付失败'
    							} 
				                    $.alert(message,function () {});
//					                
				                // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
				                //因此微信团队建议，当收到ok返回时，向商户后台询问是否收到交易成功的通知，若收到通知，前端展示交易成功的界面；若此时未收到通知，商户后台主动调用查询订单接口，查询订单的当前状态，并反馈给前端展示相应的界面。
				            });
				            WeixinJSBridge.log('yo~ ready.');
	        			}else{
	        				$.toast(rst.Message);
	        			}
	        			
	        		}
	        	});
    		}
    	});
    }, false);
	$(function(){ 
		setTimeout(function(){
			$.hideLoading();
			$('#app').css('display','block');
			
		},200);	
		if(@WorkContext.UserInfo.UserMoney>0){
			$('.weui-hongbao').prop("checked", true)
		}
		pay.payNow = function(){
	        var payAmount=$('#money').val();
	        if(payAmount==''||payAmount==0.00){
				$(this).prop("checked",false);			
				$.alert('金额不能为空',function () {});
				return false;
			}else if($('.weui-hongbao').prop("checked")==false&&$('.weui-weixin1').prop("checked")==false&&$('.weui-zf').prop("checked")==false){
				$.alert('请选择支付方式',function () {});
			}else if($('.weui-weixin1').prop("checked")==true&&$('.weui-zf').prop("checked")==true){
				$.alert('微信和支付宝不能同时使用',function () {});
				return false;
			}
	        var redPacket=0;    
			var Packet=@WorkContext.UserInfo.UserMoney;
			var PayAmount=$('#money').val();
			if($('.weui-hongbao').prop("checked")){ 
		 	    if($('.weui-zf').prop("checked")){
				 	if(Packet>PayAmount){
						redPacket=PayAmount;
						packet(1,PayAmount,redPacket);
						return false;
				     }else{	
							redPacket=Packet;
					}
				     zf(3,redPacket,PayAmount);
				     return false;
				}else if(!$('.weui-weixin1').prop("checked")&&!$('.weui-zf').prop("checked")){
					if(Packet<PayAmount){
						$.alert('红包余额不足',function () { });
					}else{
						redPacket=PayAmount;
						packet(1,PayAmount,redPacket);
						return false;
					}
	 	        }
			}else{
			 	if($('.weui-zf').prop("checked")){
			 		zf(3,0,PayAmount)
			 	}
			}  
		};
	    $("#payNow").on("click", function(){  pay.payNow() })    
	});
	
	
	
	function packet(payType,PayAmount,redPacket){
		//红包支付
	    var data={ payType:payType,PayAmount:PayAmount,ShopId:@ViewData["ShopId"],RedPacket:redPacket}
	 	$.ajax({
	 		type: 'post',
	 		url: 'shoppay',
	 		data: data,
	 		dataType: 'json',
	 		success: function(data){
	 			console.log(data)
	 			if(data.Code==1){
				window.location.href='/m/Settlement/PayResult'
	 			}else{
	 				 $.alert(JSON.stringify(data),function(){});
	 			}
	 		},
	 		error: function(xhr,type){
	 			console.log(xhr);
	 			$.alert(JSON.stringify(xhr),function(){});
	 		}
	 	});
	}
	function zf(paytype,redPacket,PayAmount){//支付宝支付
		var url="/m/settlement/ShopAlipay?payType="+paytype+"&PayAmount="+PayAmount+"&ShopId="+@ViewData["ShopId"]+"&RedPacket="+redPacket;
	    window.location.href =url ;
	}
	var vm = new Vue({
	 	el: '#app',
	 	data:{
	 	  money:'',
	 	  jifen:0,
	 	  profits:0,
	 	  hbcheck:false,
	 	  islogo:false,
	 	  hongbao:@WorkContext.UserInfo.UserMoney,
	 	  shopdetail:{},
	 	  shopid:@ViewData["ShopId"]
	 	},
	 	 computed:{
	 	 },
	 	methods:{
	 		clickzf:function(){
		     	if($('.weui-weixin1').prop("checked")){
		     		$('.weui-weixin1').prop("checked",false);
		     		$('.weui-zf').prop('checked',true)
		     	}else{
		     		$('.weui-zf').prop('checked',true)
		     	}
	 		},
	 		clickweixin:function(){
				if($('.weui-zf').prop("checked")==true){
		     		$('.weui-zf').prop("checked",false);
		     		$('.weui-weixin1').prop('checked',true)
		     	}else{
		     		$('.weui-weixin1').prop('checked',true)
		     	}
	 		},
	 		jfdikou:function(){     			
			this.jifen=this.money*this.profits/100*6
			console.log(this.money*this.profits/100*6)
	 		},
	 		getShopDetail:function(){
	 			var _this=this;
				$.ajax({
	        		type:"get",
	        		url:"/Api/Shop/GetShopInfo?ShopId="+_this.shopid,
	        		async:true,	        		
	        		success:function(rst) {
	        			var data=rst.data;
	        			_this.shopdetail=data
	        			_this.profits=data.profits
	        			_this.islogo=true
	        		}
			    });
		    },
		    testvalue:function(){
			    var _this=this;
		   	    _this.money=Number(_this.money).toFixed(2);
		 		this.jifen=(this.money*this.profits/100*6).toFixed(2)
		 		if(_this.money.toString().length>8){
		 		 	$.alert('金额不能超过10万',  function () { });
		     	}
			}
	    },
	    watch:{
	 		money: function(val,oldval) {
		 	    var _this=this;     	   
				if (!/(^[1-9]([0-9]+)?(\.[0-9]{1,2})?$)|(^(0){1}$)|(^[0-9]\.[0-9]([0-9])?$)/.test(val)) {
				    var result = parseFloat(val);
				    if (isNaN(result)) {
					  	if(_this.money==0.00){
					       _this.money=''
					       this.jifen=0.00
						}else{
						  _this.money=Number(val).toFixed(2)
						   this.jifen=0.00
						}
				    }else {
			    	    if(_this.money==0.00){
					       _this.money=''
						}else{
							    _this.money=Number(val).toFixed(2)
						}
			        }
			    }else{
			        if(_this.money>_this.hongbao){
			          	$('.weui-zf').prop("checked", true)
			        	_this.clickweixin();
			        	_this.clickzf();
			        }else{
			          	$('.weui-zf').prop("checked", false)
			        }
			    	this.jifen=(this.money*this.profits/100*6).toFixed(2)
			    }
	 	    }
	 	},
	 	mounted:function(){
	 		var _this=this;
		    _this.getShopDetail();
		    if(_this.hongbao>0){
	            $('.weui-hongbao').prop("checked", true)
		    }
	 	}
	})*/
	</script>
 </body>
</html>
