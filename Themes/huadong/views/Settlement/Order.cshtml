<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/style/weui.css"/>
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/style/weui2.css"/>
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/icon/icon.css?v=0.16">
		<script src="/Mobile/weui/ydui.flexible.js" type="text/javascript" charset="utf-8"></script>
		<script src="/Mobile/weui/zepto.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js" type="text/javascript" charset="utf-8"></script> 
		<script src="/Js/Mobile/md5.js" type="text/javascript"></script>
		<title></title>
		<style type="text/css">
			body{font-size: 0.24rem;width: 7.5rem;margin: 0 auto;background: #fff;}
			#order{display: none;}
			.weui-header{background: #fff;color: #666;font-size: 0.28rem;font-family: "微软雅黑";}
			.weui-header a{color: #666;}
			.weui-header .weui-header-left a{color: #666;}
			.weui-header .weui-header-title, .weui-header h1{color: #666;}
			.weui-header .weui-header-left, .weui-header .weui-header-right{color: #666;}
			.main{font-size: 0.24rem;font-family: "微软雅黑";position:relative;top:15%;}
			.card-box{background: #fff;border-radius: 10px;height: 9.6rem;position: relative; margin: 0rem 0.2rem 0.2rem 0.2rem;-moz-box-shadow:1px 1px 10px #d9d9d9; -webkit-box-shadow:1px 1px 10px #d9d9d9; box-shadow:1px 1px 10px #d9d9d9;}
			.card-bottom{position: absolute;width: 6.5rem;left: 0.3rem;top: 1.9rem;}
			.infos-box{position: absolute;top: -.6rem;width: 100%;}
			.infos-box img{width: 1.6rem;height: 1.6rem;border-radius: 50%;display: block;margin: 0 auto;}
			.infos-box p{height: 0.6rem;line-height: 0.6rem;text-align: center;}
			.infos-box .btn{width: 1.5rem;height: 0.56rem;line-height: 0.56rem;text-align: center;color: #fff;background: #ff4800;margin: 0 auto;border-radius: 15px;}
			.pay-infos{}
			.pay-infos .title{height: 0.6rem;line-height: 0.6rem;color: #333;font-size: 0.32rem;}
			.pay-infos .input-box{font-size: 0.36rem;color: #000;position: relative;height: 1rem;line-height: 1rem;margin: 0.2rem 0;}
			#money{height: 1rem;line-height: 1rem;border: none;outline: none;width: 5.3rem;padding-left: 0.6rem;font-size: 0.6rem;text-align: center;}
			.pay-infos .input-box:before{content: "¥";position: absolute;top: 0;left: 0;font-size: 0.6rem;}
			.pay-infos .input-box:after{content: "";position: absolute;bottom: 0;left: 0;height: 1px;width:100%;background: #d9d9d9;}
			.get-score-info{line-height: 0.6rem;}
			.get-score-info .lt{color: #999;}
			.get-score-info .rt{}
			.confirm{display:block;width: 6.5rem;margin: 0.3rem auto 0 auto;height: 0.8rem;line-height: 0.8rem;background:  #ff4800;color: #fff;text-align: center;border-radius: 5px;font-size: 0.32rem;position: fixed;bottom: 0.5rem;left: 0; right:0;}
			.confirm:active{opacity: 0.7;color: #fff;}
			
			.bg-white{background:#fff}
			.color_gray{color:#8C8C8C}
			.joinpay_list{background:#fff}
			.Payment{margin:10px 0;background:#fff;box-sizing:border-box}
			.joinpay_list .weui_cell:before{border-top:0;padding:0!important;margin:0!important;left:0!important}
			.joinpay_thumb i{font-size:30px;color:#e4393c;margin-right:10px;box-sizing:border-box}
			.sw_right{float:right}
			.chose_list{background:#fff;padding:0 12px;box-sizing:border-box}
			.chose_list .weui-flex{align-items:center;padding:6px 0;border-bottom:1px solid #E8E8E8}
			.chose_list .weui-flex:last-child{border-bottom:none}
			.chose_list .weui-flex .weui-flex-item span{font-size:14px;color:#8C8C8C}
			.now_payment{background:#fff;width:100%;text-align:center;margin-top:10px;padding:15px 0}
			.now_payment button{border:0;outline:0;width:80%;height:35px;line-height:35px;text-align:center;border-radius:35px;background:#E02E24;color:#fff;font-size:16px;margin:0 auto}
			.weui_cell{padding:4px 15px}
			.red-money{color:#E02E24;font-weight:600}
			.disabled{background:#f2f2f2;color:#999}
			.appclass{position:relative;top:15%;display:none}
			.weui_dialog_hd{padding:0!important}
			.weui_toast{width:3rem;min-height:3rem;left:31%;top:35%;margin-left:0}
			.password-shade{display: none;position: fixed;width: 7.5rem;top: 0;left: 50%;margin-left: -3.75rem;height: 100%;z-index: 20;background: rgba(0,0,0,0.5);}
			.password-box{position: absolute;border-radius: 5px; z-index: 21;width: 6.5rem;height: 4rem;bottom: 50%;margin-bottom: -2rem;left: 0.5rem;right: 0.5rem;background: #fff;font-size: 0.32rem;}
			.password-box .title{position: relative;height: 0.8rem;line-height: 0.8rem;text-align: center;padding: 0 0.2rem;border-bottom: 1px solid #f2f2f2;}
			.close-password{position: absolute;width: 0.6rem;height: 0.6rem;line-height: 0.6rem;top: 0;right: 0.2rem;vertical-align: middle;color: #f00;}
			.close-password .icon{font-size: 0.4rem;vertical-align: middle;text-align: center;}
			.pass-input{padding: 1rem 0.3rem;}
			.password-box .input-box{width: 5.9rem;}
			.password-box .box{position: relative;width: 5.9rem;position: relative;height: 0.8rem;line-height: 0.8rem;z-index: 21;}
			.password-box .input-box .weui-flex{width: 5.9rem;height: 0.8rem;line-height: 0.8rem;}
			.password-box .weui-flex .weui-flex-item{width: 0.8rem;border: 1px solid #d9d9d9;text-align: center;}
			.password-box .password{width: 5.9rem;top: 0;left: 0;height: 0.8rem;line-height: 0.8rem;border: 0;outline: 0;position: absolute;opacity: 0;}
			input:-webkit-autofill, textarea:-webkit-autofill, select:-webkit-autofill{background: #fff !important;}
			.weui-flex-item div{height: 0.8rem;line-height: 0.94rem;font-size: 0.4rem;}
			.weui_toast{font-size: 0.32rem;}
			.password-box .password {
			    top: -1rem;
			    height: 1.8rem;
			    line-height: 1.8rem;
			}
			.pass-input{padding-bottom: 0;}
			.forgetpwd{text-align: right;color: #00BFFF;padding: 0.1rem 0.3rem;}
			    .alipaycr{color:#56abe4!important}
	          .weixincr{color:#09bb07!important}
		</style>
	</head>
	<body>
		<div id="order">
			
			<div class="weui-header "> 
		    	<div class="weui-header-left" onclick="goToBack()"> <a class="icon iconfont">&#xe60e;</a></div>
			    <h1 class="weui-header-title">去付款</h1>
			    <div class="weui-header-right"></div> 
		    </div>
		    <div class="weui-form-preview">
	            <div class="weui-form-preview-hd">
	                <label class="weui-form-preview-label">订单金额:<span v-show="Number(shipFee)>0">(包含运费{{shipFee}}元)</span></label>
	                <em class="weui-form-preview-value">¥<span>{{money}}</span></em>
	            </div>
	            <!--支付方式start-->
	    		<div class="chose_payment">
					<div class="chose_list">
						<div class="weui-flex" v-show="isScore==10">
							<div class="joinpay_thumb">
								<i class="icon iconfont" style="color: yellow;">&#xe643;</i>
							</div>
							<div class="weui-flex-item">
								<p>用户积分(<span class="userscore">{{userScore}}</span>)</p>
							</div>
							<div class="sw_toggle">
								<div class="sw_right sw-hb">需付积分：{{payCreditMoney}}</div>
							</div>
						</div>
						<!--div class="weui-flex">
							<div class="joinpay_thumb">
								<i class="icon iconfont">&#xe656;</i>
							</div>
							<div class="weui-flex-item">
								<p>红包余额(<span class="usermoney">{{userMoney}}</span>)</p>
							</div>
							<div class="sw_toggle">
								<div class="sw_right sw-hb">
			                    	<input class="weui_switch weui-hongbao" id="redpackt" data-id="1" type="checkbox" v-on:click="checkPay(1)" />
			                	</div>
							</div>
						</div-->
						<div class="weui-flex">
							<div class="joinpay_thumb">
								<i class="icon iconfont alipaycr">&#xe638;</i>
							</div>
							<div class="weui-flex-item">
								<p>支付宝</p>
							</div>
							<div class="sw_toggle">
								<div class="sw_right">
			                    	<input class="weui_switch weui-wx weui-zf" id="apliy" data-id="2"  type="checkbox" v-on:click="checkPay(2)" />
			                	</div>
							</div>
						</div>
						@if (Yitao.Core.WebHelper.IsWeiXin())
    					{
						<div class="weui-flex">
							<div class="joinpay_thumb">
								<i class="icon iconfont weixincr">&#xe6e1;</i>
							</div>
							<div class="weui-flex-item">
								<p>微信支付</p>
							</div>
							<div class="sw_toggle">
								<div class="sw_right">
			                    	<input class="weui_switch weui-wx weui-weixin1" id="weixin" data-id="3" type="checkbox" v-on:click="checkPay(3)" />
			                	</div>
							</div>
						</div>
						}
					</div>
				</div>
	    		<!--支付方式end-->
		      	
	        </div>
	        <a class="btn confirm" id="payNow" v-on:click="confirmPay()">
	      		<span v-if="payMoney>0">还需支付{{Number(payMoney).toFixed(2)}}</span>
	      		<span v-else>确认支付</span>
	      	</a>
            <div class="password-shade">
			    <div class="password-box">
			    	<div class="title" onclick="closePwd()">
			    		输入密码
			    		<div class="close-password"><span class="icon iconfont">&#xe62d;</span></div>
			    	</div>
			    	<div class="pass-input">
			    		<div class="box">
			    			<input type="password" name="password" style="display: none;" />
			    			<input type="number" name="password" class="password" v-model="pwd" />
				    		<div class="input-box">
				    			<div class="weui-flex">
				    				<div class="weui-flex-item"><div v-show="pwd.length>0">*</div></div>
				    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>1">*</div></div>
				    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>2">*</div></div>
				    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>3">*</div></div>
				    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>4">*</div></div>
				    				<div class="weui-flex-item" style="border-left: 0;"><div v-show="pwd.length>5">*</div></div>
				    			</div>
				    		</div>
			    		</div>
			    	</div>
			    	<div class="forgetpwd"><a href="/m/account/resetpaypwd">忘记密码</a></div>
			    </div>
		    </div>
	        
	        
		</div>
        
    <script type="text/javascript">
	$.showLoading(); 
    var IsApp = "@WorkContext.IsApp";
    var orderId = "@Model.OrderInfo.OrderId";
    var paypwd = "@WorkContext.UserInfo.PayPwd";
    var userid = "@WorkContext.Uid";
    var sellerid = "@Model.OrderInfo.SellerId";
    var orderData = {
    	userMoney: "@WorkContext.UserInfo.UserMoney",
		money: "@Model.OrderAmount",
		payType: 1,
		isScore: '@Model.OrderInfo.OrderType',
		shipFee: "@Model.OrderInfo.ShipFee",
		userScore: "@WorkContext.UserInfo.UserScore",
		payCreditMoney: "@Model.OrderInfo.PayCreditMoney",
		payMoney: "@Model.OrderAmount",
		pwd: '',
		curuserid: 0
    }
    //返回交互
	function goToBack() {
		var _this = this;
		if(IsApp==1){
			if(navigator.userAgent.indexOf("iPhone")>0){
				gobacklastpage();
			}
			if(navigator.userAgent.indexOf("Android")>0){
				window.js.goBack();
			}
		}else{
			window.history.back();
		}
			
	}
	//初始页面获取用户信息 根据uid获取用户积分
	function initGetUserScore(){
		$.ajax({
			type:"get",
			url:"/Api/User/GetUserByUserId?userid="+userid+"&t="+Math.random(),
			async:true,
			success: function(rel) {
				if(rel.code==1){
					if(Number(orderData.userScore)!=rel.data.userscore){
						vm.userScore = rel.data.userscore;
						$(".userscore").text(rel.data.userscore);
					}
					if(Number(orderData.userMoney)!=rel.data.usermoney){
						vm.userMoney = rel.data.usermoney;
						$(".usermoney").text(rel.data.usermoney);
					}
				}
			}
		});
	}
	var payInfo = {};
	var vm = new Vue({
		el: "#order",
		data: orderData,
		created: function() {
			this.getSellerUserInfo();
		},
		methods: {
			getSellerUserInfo: function() {
				var _this = this;
				$.ajax({
					type:"get",
					url:'/Api/Seller/MiniGetSellerInfo?SellerId='+sellerid,
					async:true,
					success: function(rel) {
						if(rel.code==1){
							_this.curuserid = rel.data.userid;
						}
					}
				});
			},
			checkPay: function(type) {
				var RedPacktMoney = 0;
				if(Number(vm.money)<=Number(vm.userMoney)){
					RedPacktMoney = Number(vm.money);
				}else{
					RedPacktMoney = Number(vm.userMoney);
				}
				var type = type;
				if($("#redpackt").prop("checked")){
					if(type==2 || type==3){
						if(Number(this.money)>0){
							if(Number(this.money)<=Number(this.userMoney)){
								$("#apliy,#weixin").prop("checked",false);
								$.alert("您的红包余额已经足够支付，快去用红包付款吧");
							}else{
								if(type==2){
									$("#weixin").prop("checked",false);
								}else if(type==3){
									$("#apliy").prop("checked",false);
								}
							}
						}else{
							$("#apliy,#weixin").prop("checked",false);
							$.alert("订单错误，请返回订单页重新提交");
						}
					}else{
						if(Number(this.money)<=Number(this.userMoney)){
							$("#apliy,#weixin").prop("checked",false);
						}
					}
					vm.payMoney = Number(vm.money)-RedPacktMoney;
				}else{
					vm.payMoney = Number(vm.money);
					if(type==2){
						$("#weixin").prop("checked",false);
					}else if(type==3){
						$("#apliy").prop("checked",false);
					}
				}
			},
			confirmPay: function() {
				if(Number(userid)==Number(this.curuserid)){
					$.alert("不能购买自己店铺的商品");
					return false;
				}
				var _this = this;
				var nowTime = new Date().getTime();
			    var clickTime = $("#payNow").attr("ctime");
			    if( clickTime != 'undefined' && (nowTime - clickTime < 3000)){
			        //$.alert('操作过于频繁，稍后再试');
			        return false;
			    }else{
			        $("#payNow").attr("ctime",nowTime);
			        if(Number(this.money)<=0){
						$.alert("订单错误，请返回订单页重新提交");
					}else{
						if($(".weui_switch:checked").length<=0){
							$.alert("请选择支付方式");
						}else{
							if(Number(orderData.isScore==10)){
								console.log(orderData.isScore);
								//积分购订单
								$.ajax({
									type:"get",
									url:"/Api/User/GetUserByUserId?userid="+userid+"&t="+Math.random(),
									async:true,
									success: function(rel) {
										if(rel.code==1){
											if(Number(orderData.userScore)!=rel.data.userscore){
												_this.userScore = rel.data.userscore;
												$(".userscore").text(rel.data.userscore);
											}
											if(Number(orderData.userMoney)!=rel.data.usermoney){
												_this.userMoney = rel.data.usermoney;
												$(".usermoney").text(rel.data.usermoney);
											}
											if(Number(rel.data.userscore)>=Number(orderData.payCreditMoney)){
												var redType = $("#redpackt").prop("checked");
												var apliyType = $("#apliy").prop("checked");
												var weixinType = $("#weixin").prop("checked");
												if(redType){
													if($(".weui_switch:checked").length==1){
														//红包支付
														if(Number(vm.money)<=Number(vm.userMoney)){
															redPay();
														}else{
															$.alert("红包余额不足，请再选择一个其他支付方式进行支付");
														}
													}else if($(".weui_switch:checked").length>1){
														//支付宝支付
														if(apliyType){
															apliyPay();
														}
													}
												}else{
													//支付宝支付
													if(apliyType){
														apliyPay();
													}
												}
											}else{
												$.alert("您的积分不足");
											}
											
										}
									}
								});
							}else{
								//普通订单
								var redType = $("#redpackt").prop("checked");
								var apliyType = $("#apliy").prop("checked");
								var weixinType = $("#weixin").prop("checked");
								if(redType){
									if($(".weui_switch:checked").length==1){
										//红包支付
										if(Number(vm.money)<=Number(vm.userMoney)){
											redPay();
										}else{
											$.alert("红包余额不足，请再选择一个其他支付方式进行支付");
										}
									}else if($(".weui_switch:checked").length>1){
										//支付宝支付
										if(apliyType){
											apliyPay();
										}
									}
								}else{
									//支付宝支付
									if(apliyType){
										apliyPay();
									}
								}
							}
						}
					}
			    }       
					
			}
			
		},
		watch:{
	 		pwd: function(val,oldval) {
	 			if(val.length>6){
	 				this.pwd = oldval;
	 			}else{
	 				if(this.pwd.length==6){
	 					
	 					var cur_pwd = this.pwd+"@WorkContext.UserInfo.PaySalt";
	 					cur_pwd = hex_md5(cur_pwd);
	 					if(paypwd==cur_pwd){
	 						$(".password-shade").hide();
	 						finalRedPay();
	 					}else{
	 						this.pwd="";
	 						$.toast("密码错误","cancel");
	 					}
	 				}
	 			}
	 		}
	    }
		
		
	});
	function closePwd() {
		$(".password-shade").hide();
	}
	function finalRedPay() {
		isPay=1;
		var RedPacket = 0;
		if(Number(vm.money)<=Number(vm.userMoney)){
			RedPacket = vm.money;
			var data={ payType:1,PayAmount:vm.money,RedPacket:RedPacket,Id:orderId,Score:vm.score}
			//console.log(data);
		 	$.ajax({
		 		type: 'post',
		 		url: 'order',
		 		data: data,
		 		dataType: 'json',
		 		success: function(data){
		 			if(data.Code==1){
						window.location.href='/m/settlement/payresult?orderid=' + orderId;
		 			}else{
		 				$.alert(data.Message);
		 			}
		 		},
		 		error: function(xhr,type){
		 			console.log(xhr);
		 			$.alert(JSON.stringify(xhr),function(){});
		 		}
		 	});
		}else{
			$.alert("红包余额不足，请选择其他支付方式");
		}
		setTimeout(function(){
			isPay = 0;
		},2000);
	}
	var isPay = 0;
	//红包支付
	function redPay() {
		if(paypwd==""){
			if(isPay==0){
				finalRedPay();
			}
		}else{
			//弹出密码框
			$(".password-shade").show();
			$(".password").focus();
		}
		
	}
	//用支付宝支付
	function apliyPay() {
		var RedPacket = 0;
		if($("#redpackt").prop("checked")){
			if(Number(vm.money)<=Number(vm.userMoney)){
				RedPacket = vm.money;
			}else{
				RedPacket = vm.userMoney;
			}
		}else{
			RedPacket = 0;
		}
		var url='/m/settlement/MallAlipay?payType=2'+'&PayAmount='+vm.money+'&RedPacket='+RedPacket+"&Id="+orderId+"&Score="+vm.score;
	    window.location.href =url ;
	}
	//用微信支付
	function wxPay() {
		var RedPacket = 0;
		if($("#redpackt").prop("checked")){
			if(Number(vm.money)<=Number(vm.userMoney)){
				RedPacket = vm.money;
			}else{
				RedPacket = vm.userMoney;
			}
		}else{
			RedPacket = 0;
		}
		var data={payType:3,PayAmount:vm.money,RedPacket:RedPacket,Id:orderId,Score:vm.score,t:Math.random()}
		$.ajax({
    		type:"post",
    		url:"order",
    		async:true,
    		data:data,
    		dataType:"json",
    		success:function(rst) {
    			if(rst.Code==1){
    				//公众号支付
		            WeixinJSBridge.invoke('getBrandWCPayRequest', {
		                "appId": rst.appId,
		                "timeStamp": rst.timeStamp,
		                "nonceStr": rst.nonceStr,
		                "package": rst.package,
		                "signType": "MD5",
		                "paySign": rst.paySign,
		                t: Math.random()
		            }, function (res) {
		            	//alert(JSON.stringify(res));
		            	var message=''    							
//					            	
		                if (res.err_msg == "get_brand_wcpay_request:ok") {
		                	message='支付成功'
		                	window.location.href='/m/Settlement/PayResult?orderid=' + orderId;
		                } else if(res.err_msg =='get_brand_wcpay_request:cancel'){
							message='支付过程中用户取消'
						}else if(res.err_msg =='get_brand_wcpay_request:fail'){
							message='支付失败'
						} 
	                    $.alert(message,function(){
	                   		//window.location.href = window.location.href;
	                    });
//					                
		                // 使用以上方式判断前端返回,微信团队郑重提示：res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
		                //因此微信团队建议，当收到ok返回时，向商户后台询问是否收到交易成功的通知，若收到通知，前端展示交易成功的界面；若此时未收到通知，商户后台主动调用查询订单接口，查询订单的当前状态，并反馈给前端展示相应的界面。
		            });
		            WeixinJSBridge.log('yo~ ready.');
    			}else{
    				$.alert(rst.Message);
    			}
    			
    		}
    	});
	}
	//weixin选中
    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
		$("#payNow").on("click",function() {
			if(Number(userid)==Number(this.curuserid)){
				$.alert("不能购买自己店铺的商品");
				return false;
			}
			if(Number(vm.money)<=0){
				$.alert("订单错误，请返回订单页重新提交");
			}else{
				if($(".weui_switch:checked").length<=0){
					$.alert("请选择支付方式");
				}else{
					var weixinType = $("#weixin").prop("checked");
					if(weixinType){
						wxPay();
					}
						
				}
			}
			
		});
	});    
	$(function(){
		initGetUserScore();
		setTimeout(function(){
			$.hideLoading(); 
			$("#order").css("display","block");
			if(Number(vm.money)<=Number(vm.userMoney)){
				$("#redpackt").prop("checked",true);
			}
		},300);
	})
    </script>  
        
	</body>
</html>
