@{ Layout = null; }
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
		<meta content="telephone=no" name="format-detection">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>我的砍价-@{@WorkContext.SellerInfo.SellerName}</title>
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/style/weui.css"/>
	    <link rel="stylesheet" type="text/css" href="/Mobile/weui/style/weui2.css"/>
	    <link rel="stylesheet" type="text/css" href="/Mobile/weui/icon/icon.css"/>
		<script src="/Mobile/weui/zepto.min.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript" charset="utf-8" src="/Mobile/weui/ydui.flexible.js"></script>
		<script src="/Js/vue/dist/vue.min.js" type="text/javascript" charset="utf-8"></script> 
		<style>
* {touch-action: pan-y;}
body,html{background-color: #eee;}
.bargain-content{width: 100%;max-width: 7.5rem;margin: 0 auto;color: #333;}
.common-header {position: relative;background: #fff;height: 0.8rem;line-height: 0.8rem;-moz-box-shadow: 0px 2px 10px #d9d9d9;-webkit-box-shadow: 0px 2px 10px #d9d9d9;box-shadow: 0px 2px 10px #d9d9d9;}
.weui_media_box .weui_media_title {font-weight: 400;font-size: 0.28rem;width: auto;height: 0.88rem;overflow: hidden;text-overflow: ellipsis;white-space: unset;word-wrap: normal;word-wrap: break-word;word-break: break-all;-webkit-line-clamp: 2;}
.ell-1 {overflow: hidden;text-overflow: ellipsis;white-space: nowrap;}
.common-header .title {text-align: center;padding: 0 1rem;color: #ff4800;font-size: 0.3rem;}
.common-header .header-back{position: absolute;top: 0;left: 0;width: .6rem;height: 100%;text-align: center;}
.common-header .header-menu{position: absolute;top: 0;right: 0;width: .6rem;height: 100%;text-align: center;}
.common-header .header-back span,
.common-header .header-menu span{display: block;}
.weui_cells:after{ border-bottom: 1px solid #F7F7F7;}
.weui_media_box.weui_media_appmsg{background-color: #fff;    border-bottom: 1px solid #F7F7F7;}
.weui_media_box.weui_media_appmsg{display: -webkit-box;-webkit-box-align: start;position: relative;z-index: 9;}
.weui_media_box.weui_media_appmsg:active{background-color: #fff;}
.weui_media_box.weui_media_appmsg .weui_media_hd{width: 1.8rem;height: 1.8rem;margin-right: 0.3rem;}
.weui_media_box .weui_media_title,.weui_media_box .weui_media_desc{color:#666;}
.weui_media_desc{ color:#ff4800!important}
.weui_media_desc-1{margin:0.2rem;overflow: hidden;line-height: 0.5rem;/*position:relative;*/}
 .weui_media_desc-1>span{margin-left:0.2rem; }   
.weui_media_bd .weui_media_desc:last-child{margin-top: 0.4rem;overflow: hidden;line-height: 0.5rem;}
 .bargain-price{font-size: 0.35rem;color:#ff4800;}
.bargain-buy{display: inline-block;/*width: 1.6rem;*/line-height: 0.5rem;/*background-color: #FF4800;*/text-align: center;border-radius: 3px;overflow: hidden;color:#333;font-size: 0.26rem;z-index: 99;display: inline-block;float: right;}
.gobuy {display: inline-block;width: 1.6rem; line-height: 0.5rem; background-color: #FF4800; text-align: center;border-radius: 3px;overflow: hidden;color: #fff;font-size: 0.26rem;z-index: 99;display: inline-block;float: right;}
.gobuy a{display: block; color:#fff;}
.bargain-buy span{color:#FF4800;}
.weui-tab {position: relative;height: 100%;}
.weui-navbar {display: -webkit-box;display: -webkit-flex;display: flex;justify-content: space-between;/*position: fixed;*/z-index: 500;top:1rem;width:7.5rem;margin:0 auto;/*padding:0 0.3rem;*/background-color: #FF4800;color:#fff;padding-bottom:0.06rem;}
.weui-navbar__item.weui-bar__item--on {color: #ff4800;background-color: #fff;}
.weui-navbar__item {color: #6a6a6a;font-size: 0.28rem;color:#fff;padding: 0;line-height:0.8rem;background: #ff4800;position: relative;width: 25%;margin: 0 auto;text-align: center;}
.weui-navbar__item.weui-bar__item--on {color: #fff;background-color: transparent;border-bottom: 2px solid #fff;}
.status_bottom{display: flex;justify-content: flex-end;background: #fff;}
.time{display: inline-block;font-size: 0.28rem; float: right;right: 4.08rem;}
.bargain-list{margin-bottom:0.2rem}
#app{display:none;}
.nobuy {
    display: inline-block;
    width: 1.6rem;
    line-height: 0.5rem;
    background-color: #999;
    text-align: center;
    border-radius: 3px;
    overflow: hidden;
    color: #fff;
    font-size: 0.26rem;
    z-index: 99;
    display: inline-block;
    float: right;
}
.weui_dialog_hd{padding:0;}
</style>
</head>

	<body>
		<div id="app">
        <div class="bargain-content">
		<div class="common-header">
			<div class="header-back" onclick="goToBack()"><span class="icon iconfont">&#xe60e;</span></div>
		    <div class="title ell-1">砍价购买</div>
		    <!--<div class="header-menu" onclick="share()"><span class="icon iconfont">&#xe620;</span></div>-->
	    </div>
	    <div class="weui_tab">
	       	<div class="weui-navbar">
					<div class="weui-navbar__item" v-for='(item,index) in statusList' :class='{"weui-bar__item--on":statusid==item.id}' v-on:click='chosestatus(item)'>
						{{item.name}}
					</div>
					
				</div>
	      </div>
	      <div v-if='sort==0'>
			    <div class="bargain-list" v-for='(item,index) in dataList' :key='index' >
			        <div class="weui_panel_bd">
		                <a href="javascript:;" class="weui_media_box weui_media_appmsg" >
		                    <div class="weui_media_hd">
		                    	<img style='width:100%' :src="'@(WorkContext.ShopConfig.ImageCDN)/'+item.productimgurl" alt="" />
		                    </div>
		                    <div class="weui_media_bd">
		                        <h4 class="weui_media_title" v-text='item.productname'></h4>
		                        <!--<p class="weui_media_desc">原价¥140 最低砍至<strong class="bargain-price">¥56</strong></p>-->
		                        <p class="weui_media_desc">¥{{item.originalprice}}
		                        	<span class="bargain-buy" v-if='item.saleprice==0&&item.saleprice==0'>已砍至底价<span style='color:#FF4800'>¥{{item.limitprice}}</span></span>
		                        	<span class="bargain-buy" v-else-if='item.orderstatus==0'>距离底价还差<span v-text='(item.saleprice).toFixed(2)'></span>元</span>
		                        </p>
		                    </div>
		                </a>
		            </div>
		            <div class='status_bottom'>
		        	    <div class="weui_media_bd">
		                    <p class="weui_media_desc-1" v-if='statusid==0'>
		                    	<span class="gobuy" v-if='item.orderstatus==0' v-on:click='gostatus(item)'>继续砍价</span>
		                    	<span class="gobuy" v-if='item.canbuyprice>=(item.originalprice-item.bargainprice)||(item.originalprice-item.bargainprice)<=item.limitprice||item.orderstatus==1' v-on:click='BargainOrderAdd(item)'>立即购买</span>
		                    	<span class='time' v-text='item.timers'></span>
		                    </p>
		                    
		                </div>
		            </div>
			    </div>
	     </div>
	    <!--待发货已完成-->
	    <div v-else>
		     <div class="bargain-list" v-for='(item1,index1) in dataListcomplete' :key='index1' >
		     	<div v-for='(item,index) in item1.orderdetails' :key='index'>
				        <div class="weui_panel_bd">
			                <a href="javascript:;" class="weui_media_box weui_media_appmsg" v-on:click='godetail(item)'>
			                    <div class="weui_media_hd">
			                    	<img style='width:100%' :src="'@(WorkContext.ShopConfig.ImageCDN)/'+item.productimgurl" alt="" />
			                    </div>
			                    <div class="weui_media_bd">
			                        <h4 class="weui_media_title" v-text='item.productname'></h4>
			                        <p class="weui_media_desc">¥{{item.originalprice}}
			                        	<span class="bargain-buy" >已付款<span style='color:#FF4800'>¥{{item.subtotal}}</span></span>
			                        </p>
			                    </div>
			                </a>
			            </div>
	             </div>
	            <div class='status_bottom'>
	        	    <div class="weui_media_bd">
	                    <p class="weui_media_desc-1"  v-if='sort==2'>
	                    	<span class="gobuy" v-if='item1.order.shipmode!=0'>
	                            <a :href="'/m/order/express?orderid='+item1.order.orderid">查看物流</a>
	                        </span>
	                        <span class="gobuy" v-on:click='goshouhuo(item1.order.orderid)'>确认收货</span>
	                    </p>
	                    <p class="weui_media_desc-1" v-if='sort==8'>
	                        <span class="gobuy"></span>
	                    </p>
	                </div>
	            </div>
	           
		    </div>
	    </div>
         <div class="loading" style="height: 1rem; line-height: 1rem;">
				<div class="weui-loadmore" v-show="loadmore">
		            <i class="weui-loading"></i>
		            <span class="weui-loadmore-tips">正在加载</span>
		        </div>
				<div class="weui_cells_title tcenter" v-show="nomore">
					没有更多砍价商品了
				</div>
		</div>
	</div>
	</div>
</body>
<script>
	var IsApp = "@WorkContext.IsApp";
	//返回交互
	function goToBack() {
		var _this = this;
		if(IsApp==1){
			if(navigator.userAgent.indexOf("iPhone")>0){
				gobacklastpage();
			}
			if(navigator.userAgent.indexOf("Android")>0){
                window.js.goBack();
			}
		}else{
			window.history.back();
		}
	}
	 var vm = new Vue({
     	el: '#app',
     	data:{
	     	statusid:0,
	     	page:1,
	     	size:10,
	     	sort:0,
	     	loadingTop: 0,
	     	loadmore:false,
	     	nomore:false,
	     	statusList:[
	     		{id:0,name:'砍价中'},
	     		{id:2,name:'待收货'},
	     		{id:8,name:'已完成'},
	     	],
	     	dataList:[],
	        dataListcomplete:[],
	     	userId:'@WorkContext.Uid',
	     	IsApp: "@WorkContext.IsApp",
     	},
     	methods:{
     		godetail:function(item){
     			var _this=this;
     			if(_this.sort!=0){
     				window.location.href='/m/order/BargainOrderDetail?Id='+item.orderid+'&IsApp='+_this.IsApp
     			}
     		},
     		 goshouhuo:function(OrderId){//确认收货
     		 	var _this=this;
				    $.confirm("为了保障您的售后权益，请收到货确认无误后，再确认收货哦！", "确认收货?", function() {
				        $.post('/m/order/Confirm', {
				            OrderId:OrderId,
				            }, function(data) {
				                console.log(data.Code);
				                _this.getcompleteBargain(2)
				                    if(data.Code==1){
				                        $.toast("操作成功");
				                    }else{
				                        //$.toast("操作失败", "forbidden");
				                    }
				            }, 'JSON');
				      }, function() {});
            },
     		BargainOrderAdd:function(data){//砍价订单添加
						var _this=this;
//						var data=_this.datadetail;
						var ShipFee=0
						var paybargainprice=data.originalprice-data.bargainprice//支付价格=原价-砍掉价格
						 if(paybargainprice>=Number(data.fullFree) && Number(data.fullFree)>0){
	            	           ShipFee = 0;
			            }else{
			            	  ShipFee =data.freight
			            }
			            var OrderAmount=paybargainprice+ShipFee;
						var dataList={
							AddressId: data.addressid, // 地址
							RegionId: data.town, // 地区邮寄地区的最后一个的id
							ShipMode: 1, // 配送方式   1  2  4
					        //UserMoney: UserMoney,
							ItemId: data.activityitemid, // 如果是直接过来穿商品ID
							SkuId: data.skuid, // 如果是直接过来 传产品
							Quantity: 1, // 如果是直接过来 这里穿数量
							Memo: data.memo, // 订单备注
							Consignee: data.consignee, // 收货人姓名
							Mobile: data.mobile, // 联系电话
							//ShipTime: ShipTime, // 提货时间
							//ShopId: ShopId, // 自提店铺
							Province: data.province, // 选择的省
							City: data.city, // 选择的市
							County: data.county, // 选择的区
							Town: data.town, // 选择的镇
							Address: data.address, // 详细地址
							OrderAmount: OrderAmount, // 订单结算后的总金额
							ShipFee:ShipFee,
							Weight:data.weight,
							RequestPayBargainPrice:paybargainprice,//去支付价格
							BargainOrderId:data.orderid,//订单id
						}
						$.ajax({
							type:"post",
							url:"/m/Order/BargainOrderAdd",
							data:dataList,
							async:true,
							success:function(rel){
								var rel=JSON.parse(rel);
								console.log(rel)
								if(rel.Code==1){
									if(_this.IsApp==1){
					                	if(navigator.userAgent.indexOf("iPhone")>0){
											settleShoppingCart(rel.OrderId);
										}
					                	if(navigator.userAgent.indexOf("Android")>0){
											window.js.settleShoppingCart(rel.OrderId);
										}
				                	}else{
				                		var url = rel.Data;
				                		_this.getMyBargain(_this.sort)
						                location.href = url;
				                		return true;
				                	}
								}else if(rel.Code==-1){
									if(_this.IsApp==1){
					                	if(navigator.userAgent.indexOf("iPhone")>0){
											settleShoppingCart(rel.Data);
										}
					                	if(navigator.userAgent.indexOf("Android")>0){
											window.js.settleShoppingCart(rel.Data);
										}
				                	}else{
				                		window.location.href = '/m/settlement/order?id='+rel.Data;
				                	}
									
								}else{
									$.toast(rel.Message)
								}
							}
						});
			  },
			 freigthByAddr:function(rel){//计算邮费
    	            	var _this=this;
						    $.get('/m/Order/GetShipTemplate', {
						        Province: rel.province,
						        City: rel.city,
						        Country: rel.country,
						        Town: rel.town,
						        SellerId:rel.sellerid,
						        t: Math.random()
						    }, function(data) {
//						    	console.log(data)
						        var datas = JSON.parse(data);
						        if (datas.Code == 1) {
						            /*
						             * 运费计算公式
						             * NumWeight  超出首重的重量(总重 - 运费模版首重) / 运费模版超重重量基数 + 没填重量的商品的个数*5
						             * CountShipFee 运费模版首重money + NumWeight * 运费模版超重价格基数
						             */
						            var freight=0
						            var NumWeight = 0;
						            if (rel.weight > datas.Data.Weight) {
						            	NumWeight = _this.calc(rel.weight, '-' , datas.Data.Weight,2);
						            	if(Number(datas.Data.AddWeight)!=0 || datas.Data.AddWeight!=""){
						            		NumWeight = Math.ceil(NumWeight / datas.Data.AddWeight);
						            	}else{
						            		NumWeight = 0;
						            	}
						            }
						            NumWeight = Number(NumWeight).toFixed(2);
						            var CountShipFee = _this.calc (datas.Data.Price,'+', NumWeight * datas.Data.AddPrice,2);
						            freight = CountShipFee;
						            if(rel.weight<=0){
						            	freight = datas.Data.Price;
						            }
						            _this.GetFullFree(rel);
						            rel.freight=freight;
                                    var paybargainprice=rel.originalprice-rel.bargainprice//支付价格=原价-砍掉价格
									 if(paybargainprice>=Number(rel.fullFree) && Number(rel.fullFree)>0){
				            	        rel.shipfee = 0;
						            }else{
						            	rel.shipfee=rel.freight
						            }
						           console.log(rel)
						        } else {
//						            $.toast("当前地址无效、请重新选择");
						        }
						    }, 'JSON');
				     },
					 calc:function(arg1, op, arg2,dot) {
					    var ra = 1, rb = 1, m;
					    try {
					        ra = arg1.toString().split('.')[1].length;
					    } catch (e) {
					    }
					    try {
					        rb = arg2.toString().split('.')[1].length;
					    } catch (e) {
					    }
					    m = Math.pow(10, Math.max(ra, rb));
					
					    switch (op) {
					        case '+':
					        case '-':
					            arg1 = Math.round(arg1 * m);
					            arg2 = Math.round(arg2 * m);
					            break;
					        case '*':
					            ra = Math.pow(10, ra);
					            rb = Math.pow(10, rb);
					            m = ra * rb;
					            arg1 = Math.round(arg1 * ra);
					            arg2 = Math.round(arg2 * rb);
					            break;
					        case '/':
					            arg1 = Math.round(arg1 * m);
					            arg2 = Math.round(arg2 * m);
					            m = 1;
					            break;
					    }
					    try {
					        var result = eval('(' + '(' + arg1 + ')' + op + '(' + arg2 + ')' + ')/' + m);
					    } catch (e) {
					    }
					    if(result.toString().indexOf(".")!=-1){
					    	var strarr = result.toString().split(".");
					    	if(strarr[1].length>dot){
					    		result = strarr[0]+"."+strarr[1].substring(0,dot);
					    	}
					    }
					    return result;
	        },
     		gostatus:function(item){
     			var _this=this;
     			    if(_this.IsApp==1){
		            	if(navigator.userAgent.indexOf("iPhone")>0){
							bargainCommodity(item.orderid.toString());
						}
		            	if(navigator.userAgent.indexOf("Android")>0){
							window.js.bargainCommodity(item.orderid.toString());
						}
		            }else{
	            	  window.location.href="/m/activity/BargainStatus?IsApp="+_this.IsApp+'&orderid='+item.orderid;
                    }
     			
     		},
     		timer:function(addtime,orderid){
	     	   var _this=this;
	           var begintime_ms = Date.parse(new Date(addtime.replace(/-/g, "/"))); //begintime 为开始时间
	           var getInervalHour=(begintime_ms)/1000/60/60;
		       var endtime=(48+getInervalHour)*60*60;
               var EndTime =  new Date(_this.timestampToTime(endtime).replace(/-/g, "/"));
               var NowTime = new Date();
	            var t = EndTime.getTime() - NowTime.getTime();
	            var h = Math.floor(t / 1000 / 60 / 60);
	            var m = Math.floor(t / 1000 / 60 % 60);
	            var s = Math.floor(t / 1000 % 60);
	          var hour
	          if(m>0&&h<=0){
	          	hour='距离结束不到1小时'
	          }else if(h>0){
	          	hour='距离结束'+parseInt(h)+'小时'
	          }else{
	          	hour=''
	          }
	          return hour;
     		},
     		chosestatus:function(item){
     			var _this=this;
     			_this.page=1;
     			_this.sort=item.id;
     			_this.statusid=item.id;
     			_this.dataList=[];
     			_this.dataListcomplete=[];
     			if(item.id==0){
     				_this.getMyBargain(item.id);
     			}else{
     				_this.getcompleteBargain(item.id)
     			}
     		},
     		timestampToTime: function(timestamp) {
			        var date = new Date(timestamp * 1000);//时间戳为10位需*1000，时间戳为13位的话不需乘1000
			        var Y = date.getFullYear() + '-';
			        var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
			        var D = (date.getDate()+1 < 10 ? '0'+(date.getDate()) : date.getDate())+ ' ';
			        var h = date.getHours() + ':';
			        var m = date.getMinutes() + ':';
			        var s = date.getSeconds();
			        return Y+M+D+h+m+s;
			},
     		getMyBargain:function(sort){
     			var _this=this;
     			var url;
     			  url="/Api/Activity/MyBargainList?v="+Math.random()+"&userId="+_this.userId+"&page="+_this.page+"&size="+_this.size+"&sort="+sort;
     			  _this.loadmore = true;
     			  _this.nomore = false;
     			$.ajax({
					type:"get",
					url:url,
					async:true,
					dataType:"json",
					success: function(rel){
						if(rel.code==1){
							var data=rel.data;
								for(var i=0;i<data.length;i++){
									data[i].timers=_this.timer(data[i].addtime,data[i].orderid);
									data[i].bargainprice=(data[i].originalprice-data[i].limitprice-data[i].saleprice).toFixed(2);//砍掉价格
									data[i].canbuyprice=(data[i].originalprice*0.1)+data[i].limitprice;//可以购买的价格
									_this.freigthByAddr(data[i]);
							    }
								_this.dataList=_this.dataList.concat(rel.data);
							_this.loadmore = !_this.loadmore;
							_this.page++;
						}else{
							_this.loadmore = false;
							_this.nomore = true;
						}
					},
				});
     		},
     		getcompleteBargain:function(sort){
     			var _this=this;
     			var url;
     			if(sort==2){
     			  url="/Api/Order/GetOrders?v="+Math.random()+"&userId="+_this.userId+"&page="+_this.page+"&rp="+_this.size+"&OrderType="+6+'&OrderStatus=1&ShipStatus=1';
     			}else if(sort==8){
     			  url="/Api/Order/GetOrders?v="+Math.random()+"&userId="+_this.userId+"&page="+_this.page+"&rp="+_this.size+"&OrderType="+6+'&OrderStatus=8';
     			}
     			  _this.loadmore = true;
     			   _this.nomore = false;
     			$.ajax({
					type:"get",
					url:url,
					async:true,
					dataType:"json",
					success: function(rel){
						console
						_this.loadmore = false;
						if(rel.code==1){
							var data=rel.data;
							
							_this.dataListcomplete=_this.dataListcomplete.concat(rel.data);
							_this.page++;
						}else{
							_this.loadmore = false;
							_this.nomore = true;
						}
					},
				});
     		},
     		
     		GetFullFree:function(rel){
     			var _this=this;
     			$.ajax({
					type:"get",
					url:"/Api/Seller/GetFullFree?v="+Math.random()+"&SellerId="+rel.sellerid,
					async:true,
					dataType:"json",
					success: function(data){
						if(data.code==1){
							rel.fullFree=data.data
						}else{
						}
					},
				});
     		},
     		
     	},
     	
    })
	 $(function(){
	 	vm.getMyBargain(vm.sort);
	 	setTimeout(function(){
	 		$('#app').css('display','block');
	 	},300)
        $(window).scroll(function(){   //滚动加载商品列表
	    	var winScrollTop = $(this).scrollTop(),
	    		docHeight = $(document).height(),
	    		windowHeight = $(this).height();
	    		if (windowHeight + winScrollTop == docHeight) {
//	    			vm.page++
					if(vm.sort==0){
						vm.getMyBargain(vm.sort);
					}else{
						vm.getcompleteBargain(vm.sort)
					}
	    			
	    		}
    	});
	 })
</script>
</html>
