@{ Layout = null; }
<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta name="format-detection" content="telephone=no">
	    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
	    <meta name="apple-mobile-web-app-capable" content="yes" />
	    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
	    <meta http-equiv="Pragma" content="no-cache" />
	    <meta http-equiv="Cache-Control" content="no-cache" />
	    <meta http-equiv="Expires" content="0" />
		<title>积分红包</title>
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/style/weui.css"/>
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/style/weui2.css"/>
		<link rel="stylesheet" type="text/css" href="/Mobile/weui/icon/icon.css"/>
		<script src="/Mobile/weui/zepto.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="/Mobile/weui/swipe.js" type="text/javascript" charset="utf-8"></script>
		<script src="/Mobile/weui/ydui.flexible.js" type="text/javascript" charset="utf-8"></script>
		<script src="/Mobile/weui/icon/iconfont.js"></script>
		<style type="text/css">
			.ell-1{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
			.ell-2{overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
			.color{color:#ff4800}
			.bg{background:#ff4800}
			.gary{color:#999}
			.common-header{position:relative;background:#ff4800;height:.8rem;line-height:.8rem;margin-bottom:.06rem;-moz-box-shadow:0 2px 10px #d9d9d9;-webkit-box-shadow:0 2px 10px #d9d9d9;box-shadow:0 2px 10px #d9d9d9}
			.common-header .title{text-align:center;padding:0 1rem;color:#fff;font-size:.3rem}
			.common-header .header-back{position:absolute;top:0;left:0;width:.6rem;text-align:center;color:#fff}
			.common-header .header-menu{position:absolute;top:0;right:0;width:.6rem;text-align:center}
			.header-menu .icon{color:#fff}
			.shade{display:none;position:fixed;width:7.5rem;height:100%;top:0;left:50%;margin-left:-3.75rem;background:rgba(0,0,0,.7);z-index:100}
			.shade-mask{position:absolute;width:100%;height:100%;top:0;left:0;z-index:101}
			.shade-content{position:absolute;bottom:0;left:0;height:8rem;background:#fff;z-index:102}
			.weui_dialog_hd{padding:0}
			.weui_toast{padding:0 15px;font-size:.32rem}
			.score-hongbao{width:7.5rem;font-size:12px;margin:0 auto;color:#333;font-family:"微软雅黑"}
			.main{margin-bottom:55px;position:relative}
			.icon{width:1em;height:1em;vertical-align:-.15em;fill:currentColor;overflow:hidden}
			.section{margin:.2rem;padding:.2rem;background:#fff;border-radius:5px;font-size:.32rem;vertical-align:middle}
			.section *{vertical-align:middle}
			.tips{background:#f60;color:#fff;padding:0 3px;border-radius:3px;font-size:.24rem}
			.section input{border:0;outline:0;width:4.45rem;padding:0 .1rem;text-align:right;height:.6rem;line-height:.6rem;font-size:.32rem}
			.section-2 input{width:4.6rem}
			textarea{width:6.6rem;border:0;outline:0;height:1.6rem}
			.score-box{opacity:.5;color:#ff4800;font-size:.6rem;font-weight:700;text-align:center;margin:.4rem 0}
			.send-score{opacity:.5;background:#ff4800;width:6rem;height:1rem;line-height:1rem;text-align:center;color:#fff;margin:0 auto;border-radius:5px;font-size:.36rem}
			.mask-shade{display:none;position:fixed;width:7.5rem;height:100%;top:0;left:50%;margin-left:-3.75rem;z-index:101;background:rgba(0,0,0,.7)}
			.mask-shade2{display:none;position:fixed;width:7.5rem;height:100%;top:0;left:50%;margin-left:-3.75rem;z-index:101;background:rgba(255,255,255,.3)}
			.alert-box{display:none;position:fixed;width:6.5rem;height:6.5rem;top:50%;left:50%;margin-left:-3.25rem;margin-top:-3rem;z-index:102;background:rgba(0,0,0,.7);border-radius:5px}
			.alert-box .content{position:absolute;width:100%;height:100%;background:#fff;z-index:103;border-radius:5px}
			.alert-box .title{height:1rem;line-height:1rem;text-align:center;position:relative;border-bottom:1px solid #e6e6e6;font-size:.4rem}
			.alert-box .close{position:absolute;top:0;left:0;width:1rem;height:1rem;line-height:1rem;text-align:center;font-size:.46rem}
			.alert-box .info-box{margin:0 .4rem;padding:.2rem 0;border-bottom:1px solid #e6e6e6}
			.alert-box p{height:.6rem;line-height:.6rem;text-align:center;font-size:.28rem}
			.alert-box .score-box{margin:0;opacity:1}
			.alert-box .my-score-box{margin:0 .4rem;padding:.2rem 0;border-bottom:1px solid #e6e6e6;font-size:.32rem}
			.alert-box .my-score-icon{font-size:.48rem;color:#ffa702}
			.alert-box .my-score{margin-left:.5rem}
			.alert-box .submit-send{margin:.2rem .4rem;opacity:.5;height:.8rem;line-height:.8rem;background:#ff4800;color:#fff;text-align:center;font-size:.32rem;border-radius:5px}
			.more-menu{width:100px;height:75px;background:#fff;position:fixed;top:.76rem;right:50%;margin-right:-3.65rem;display:none;border-radius:5px;z-index:102;padding:10px;-moz-box-shadow:1px 3px 18px #999;-webkit-box-shadow:1px 3px 18px #999;box-shadow:1px 3px 18px #999}
			.more-menu:after{content:"";position:absolute;width:0;height:0;border-width:6px;border-style:solid;top:-15px;right:3px;border-color:transparent transparent #fff transparent}
			.more-menu a{color:#333;display:block;text-align:center;line-height:25px}
			.tips-toptips{display:none;width:7.5rem;height:.45rem;line-height:.45rem;background:#930;color:#fff;text-align:center;position:absolute;top:-.2rem}
			.shade-login{position:fixed;width:7.5rem;height:100%;background:rgba(0,0,0,.5);top:0;left:50%;margin-left:-3.75rem;display:none;z-index:105}
			.login-tips{position:absolute;width:4rem;text-align:center;background:#fff;border-radius:5px;top:50%;left:50%;font-size:.24rem;padding:.6rem 0;line-height:.5rem;margin-top:-1.1rem;margin-left:-2rem}
			.login-tips a{display:block;height:.6rem;line-height:.6rem;width:2.4rem;margin:0 auto}
			.login-tips a{display:block;height:.5rem;line-height:.5rem;width:2.8rem;margin:0 auto;background:#ff4800;color:#fff;border-radius:15px}
			.poundage{padding:0 .2rem;color:red}
			.poundage-txt{display:none}
			.pwd-box{height:.8rem;width:5rem;margin:.3rem auto;overflow:hidden}
			#password{width:100%;height:.76rem}
			#payPwd .pwd-wrap{width:90%;height:44px;padding-bottom:1px;margin:0 auto;background:#fff;border:1px solid #ddd;display:flex;display:-webkit-box;display:-webkit-flex;cursor:pointer}
			.pwd-wrap li{list-style-type:none;text-align:center;line-height:44px;-webkit-box-flex:1;flex:1;-webkit-flex:1;border-right:1px solid #ddd}
			.pwd-wrap li:last-child{border-right:0}
			.pwd-wrap li i{height:10px;width:10px;border-radius:50%;background:#000;display:inline-block}
			.weui_mask{z-index:300}
			.weui_dialog,.weui_toast{z-index:300}
			.role-box{position:fixed;display: none;width: 7.5rem;top:0;left: 50%;margin-left: -3.75rem; height: 100%;background: #fff;color: #333;font-size: 0.24rem;z-index: 110;}
			.role-info{padding: 0.2rem;font-size: 0.28rem;}
		</style>
		
	</head>
	<body>
		<div class="score-hongbao" id="send_packet">
			<div class="common-header"> 
				<div class="header-back" onclick="goToBack()"><span class="icon iconfont">&#xe60e;</span></div>
			    <div class="title ell-1">积分红包</div> 
			    <div class="header-menu" onclick="openMenu()"><span class="icon iconfont">&#xe661;</span></div>
		    </div>
		    <div class="more-menu">
		    	<a href="/m/activity/ScorePacketList">
		    		<span class="icon iconfont">&#xe668;</span>
		    		<span>红包记录</span>
		    	</a>
		    	<a href="/m/article/list?cateid=2715">
		    		<span class="icon iconfont">&#xe667;</span>
		    		<span>帮助中心</span>
		    	</a>
		    	<a href="javascript:;" onclick="showRole()">
		    		<span class="icon iconfont">&#xe656;</span>
		    		<span>红包规则</span>
		    	</a>
		    </div>
		    <div class="role-box">
		    	<div class="common-header"> 
					<div class="header-back" onclick="hideRole()"><span class="icon iconfont">&#xe60e;</span></div>
				    <div class="title ell-1">红包规则</div> 
				    <!--<div class="header-menu" onclick="openMenu()"><span class="icon iconfont">&#xe661;</span></div>-->
			    </div>
			    <div class="role-info">
			    	<p>1、  设置积分红包范围为1~1000分</p>
			    	<p>2、  红包个数范围为1~200个</p>
			    	<p>3、  额外扣除5%手续费</p>
			    	<p>4、  通过抢红包注册会员的好友，直接锁定为发红包人的粉丝</p>
			    	<p>5、  积分红包48小时后未领取完将退回剩余部分</p>
			    	<p>活动最终解释权归秦商未来所有</p>
			    </div>
		    </div>
		    <div class="main">
		    	<div class="tips-toptips">
		    		单个红包金额不可低于0.1
		    	</div>
				<div class="section section-1">
					<span class="tips">拼</span>
					<span class="txt-l">总数</span>
					<input type="text" id="score1" style="position: absolute; top: -999px"/>
					<input type="" name="" autocomplete="off" id="score" value="" readonly="readonly" placeholder="0" />
					<span class="txt-r">积分</span>
				</div>
				<div class="section section-2">
					<span class="txt-l">红包个数</span>
					<input type="text" id="num1" style="position: absolute; top: -999px"/>
					<input type="text" name="" autocomplete="off" id="num" value="" readonly="readonly" placeholder="填写个数" />
					<span class="txt-r">个</span>
				</div>
				<div class="poundage" style="display: none;">手续费5% <span class="poundage-txt">需另付手续费：<span class="poundage-money"></span>积分</span></div>
				<div class="section section-3">
					<textarea id="memo" name="memo" rows="" cols="" readonly="readonly" placeholder="消费增值、人人受益！" value="消费增值、人人受益！"></textarea>
				</div>
				<div class="score-box"><span class="score">0</span> <span>积分</span></div>
				<div class="send-score" onclick="confirmScore()">塞积分进红包</div>
		    </div>
		    <div class="mask-shade"></div>
		    <div class="mask-shade2"  onclick="closeMenu()"></div>
		    <div class="alert-box">
		    	<div class="content">
			    	<div class="title">
			    		<span class="icon iconfont close" onclick="cancelSend()">&#xe654;</span>
			    		<span class="title-txt">积分红包</span>
			    	</div>
		    		<div class="info-box">
		    			<div class="score-box">
		    				<span class="score"></span>积分
		    			</div>
		    		</div>
		    		<div class="my-score-box">
		    			<span class="icon iconfont my-score-icon">&#xe666;</span>
		    			<span class="txt">我的积分</span>
		    			<span class="my-score">@WorkContext.UserInfo.UserScore</span>
		    		</div>
		    		<div id="payPwd">
		    			<input type="password" id="password" style="position: absolute; top: -999px"/>
		    			
				    	<input ref="pwd" class="password" type="text" readonly="readonly" autocomplete="off" maxlength="6" v-model="pswd"  style="position: absolute;z-index: -1;left:-100%;opacity: 0"/>
					    <ul class="pwd-wrap" v-on:click="focus">
					      <li><i v-if="msgLength > 0"></i></li>
					      <li><i v-if="msgLength > 1"></i></li>
					      <li><i v-if="msgLength > 2"></i></li>
					      <li><i v-if="msgLength > 3"></i></li>
					      <li><i v-if="msgLength > 4"></i></li>
					      <li><i v-if="msgLength > 5"></i></li>
					    </ul>
				    </div>
		    		<div class="forget-pwd" style="text-align: right;padding-right: 20px;"><a style="color: #f00;" href="/m/account/resetpaypwd">忘记密码</a></div>
		    		<div class="submit-send" onclick="send()">确认</div>
		    	</div>
		    </div>
		</div>
		<div class="shade-login">
			<div class="login-tips">
				<div class="title">您还未登录，请先登录</div>
				<a href="javascript:;" class="btn jump-url">去登录 》</a>
			</div>
		</div>
		<script src="/Js/Mobile/md5.js" type="text/javascript"></script>
		<script src="/Js/Mobile/vue.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			var IsApp = "@WorkContext.IsApp";
			var flag = 0;
			var uid = "@WorkContext.Uid";
			var isWeixin = "@WebHelper.IsWeiXin()";
			
			function calc (arg1, op, arg2,dot) {
				if(op=="/" && (arg2==0 || arg2=="")){
					result = 0;
				}else{
					var ra = 1, rb = 1, m;
			        try {
			            ra = arg1.toString().split('.')[1].length;
			        } catch (e) {
			        }
			        try {
			            rb = arg2.toString().split('.')[1].length;
			        } catch (e) {
			        }
			        m = Math.pow(10, Math.max(ra, rb));
			
			        switch (op) {
			            case '+':
			            case '-':
			                arg1 = Math.round(arg1 * m);
			                arg2 = Math.round(arg2 * m);
			                break;
			            case '*':
			                ra = Math.pow(10, ra);
			                rb = Math.pow(10, rb);
			                m = ra * rb;
			                arg1 = Math.round(arg1 * ra);
			                arg2 = Math.round(arg2 * rb);
			                break;
			            case '/':
			                arg1 = Math.round(arg1 * m);
			                arg2 = Math.round(arg2 * m);
			                m = 1;
			                break;
			        }
			        try {
			            var result = eval('(' + '(' + arg1 + ')' + op + '(' + arg2 + ')' + ')/' + m);
			        } catch (e) {
			        }
			        if(result.toString().indexOf(".")!=-1){
			        	var strarr = result.toString().split(".");
			        	if(strarr[1].length>dot){
			        		result = strarr[0]+"."+strarr[1].substring(0,dot);
			        	}
			        }
				}
			        
		        return result;
		    };
			//返回交互
			function goToBack() {
	    		if(IsApp==1){
					if(navigator.userAgent.indexOf("iPhone")>0){
						gobacklastpage();
					}
					if(navigator.userAgent.indexOf("Android")>0){
						window.js.goBack();
					}
				}else{
					window.location.href = "/m/usercenter/home";
					
				}
	
			}
			//打开辅助菜单
			function openMenu() {
				$(".mask-shade2").css("display","block");
				$(".more-menu").css("display","block");
			}
			//关闭辅助菜单
			function closeMenu(){
				$(".more-menu").css("display","none");
				$(".mask-shade2").css("display","none");
			}
			//打开积分规则
			function showRole(){
				$(".role-box").css("display","block");
			}
			//关闭积分规则
			function hideRole(){
				$(".role-box").css("display","none");
				closeMenu();
			}
			//塞积分进红包
			function confirmScore(){
				if(flag==1){
					var score = $("#score").val();
					var num = $("#num").val();
					if(score==0 || score==""){
						$.toast("请填写大于0的积分","cancel");
						return false;
					}
					if(num==0 || num==""){
						$.toast("请填写大于0的红包个数","cancel");
						return false;
					}
					if(!score_vue.isCheck){
						$.confirm("请先去实名认证", "未实名认证", function() {
		                	window.location.href='/m/usercenter/authentication';
				        }, function() {
				        });
						return false;
					}
					$(".mask-shade").css("display","block");
					$(".alert-box").css("display","block");
				}
			}
			//取消发红包
			function cancelSend() {
				$(".mask-shade").css("display","none");
				$(".alert-box").css("display","none");
			}
			//发送红包
			function send() {
				var score = $("#score").val();
				var num = $("#num").val();
				var pwd = $(".password").val();
				var memo = $("#memo").val();
				var poundageMoney = $(".poundage-money").text();
				poundageMoney = $.trim(poundageMoney);
				var count_score = calc(Number(score),"+",poundageMoney,2);
				if(pwd==""){
					return false;
				}else if(pwd.length<6){
					return false;
				}else{
					$.ajax({
						type:"get",
						url:"/Api/User/GetUserByUserId?userid="+uid,
						async:true,
						success:function(rel){
							if(rel.code==1){
								if(Number(score)>Number(rel.data.userscore)){
									$.alert("抱歉，您的积分不足！");
								}else{
									if(Number(count_score)<Number(rel.data.userscore)){
										if(rel.data.paypwd==""){
											$.alert("未设置支付密码,您可以点击“忘记密码”去设置支付密码！");
											return false;
										}else{
											var cur_pwd = pwd+"@WorkContext.UserInfo.PaySalt";
			 								cur_pwd = hex_md5(cur_pwd);
			 								if(cur_pwd==rel.data.paypwd){
			 									save(14,uid,num,score,memo);
			 								}else{
			 									$.alert("密码错误！");
												return false;
			 								}
										}
									}else{
										$.alert("抱歉，您的积分不足！需零付手续费"+poundageMoney);
									}
								}
								
							}
						}
					});
				}
			}
			//提交
			function save(sellerid,userid,redpacketnum,redpacketsum,memo){
				if(memo==""){
					memo = "消费增值、人人受益！";
				}
				$.ajax({
					type:"post",
					url:"/Api/Activity/ScoreRedPacketAdd",
					data:{sellerid:sellerid,userid:userid,redpacketnum:redpacketnum,redpacketsum:redpacketsum,memo:memo},
					async:true,
					success: function(rs){
						if(rs.code==1){
							$(".mask-shade").css("display","none");
							$(".alert-box").css("display","none");
							$.toast("发送成功！");
							window.location.href="/m/activity/ScoreOpenPacket?itemid="+rs.data+"&IsApp="+IsApp;
						}else{
							$.toast(rs.message,"cancel");
						}
					}
				});
			}
			
			//计算单个红包金额
			function calcMinScore() {
				var score = $("#score").val();
				var num = $("#num").val();
				var minScore = calc(score,"/",num,3);
				if(minScore<0.1){
					flag = 0;
                	$(".score-box").css("opacity","0.5");
                	$(".send-score").css("opacity","0.5");
                	$(".tips-toptips").css("display","block");
				}else{
					flag = 1;
                	$(".score-box").css("opacity","1");
                	$(".send-score").css("opacity","1");
                	$(".tips-toptips").css("display","none");
				}
			}
			
			
			var score_vue = new Vue({
				el: '#payPwd',
				data: {
					pswd:'',
        			msgLength:0,
        			userid: uid,
        			isCheck: false
				},
				created: function(){
					this.judegebind();
				},
				watch:{
			        pswd: function(curVal){
				        if(/[^\d]/g.test(curVal)){
				            this.pswd = this.pswd.replace(/[^\d]/g,'');
				        }else{
				            this.msgLength = curVal.length;
				            if(this.msgLength==6){
				            	$(".submit-send").css("opacity","1");
				            }else{
				            	$(".submit-send").css("opacity","0.5");
				            }
				        }
			        },
			    },
			    methods: {
			        focus:function(){
			            this.$refs.pwd.focus();
			        },
			        judegebind:function(){//判断是否实名
			    		var _this=this;
			    		$.ajax({
			    			type:"get",
			    			url:"/Api/Account/IsAuthentication?v="+Math.random()+"&UserId="+_this.userid,
			    			success: function(rel){
			    				var data=rel;
			    				if(data.code==1){
			    					_this.isCheck=true;
			    				}
			    			}
			    		});
			    	}
			    }
			});
			
			$(function(){
				if(uid<=0){
					$(".shade-login").css("display","block");
					var url;
					if(isWeixin=="False"){
						url = '/m/account/login?returnUrl='+'@(Request.Url.Scheme)://' + '@HttpContext.Current.Request.Url.Host' +'/m/activity/scoresendpacket';
					}else{
						url = '/m/user/bind?returnUrl='+'@(Request.Url.Scheme)://' + '@HttpContext.Current.Request.Url.Host' +'/m/activity/scoresendpacket';
					}
					$(".jump-url").attr("href",url);
				}
				//处理表单自动填充问题
				setTimeout(function(){
					$("input").removeAttr("readonly");
					$("textarea").removeAttr("readonly");
				},300);
				$("#score").on("input propertychange",function(){
	                var val = $(this).val();
	        		if(val==""){
	        			$(".tips-toptips").css("display","none");
	        		}
	                val = val.toString();
	                var newval = val.replace(/[^\d]/g, "");
	        		if(newval.length>4){
	    				newval = newval.substring(0,newval.length-1);
	    			}
	        		
	        		if (newval.length > 1 && newval.substring(0, 1) == 0 && newval.substring(1, 2) != ".") {
	                    newval = newval.substring(1, newval.length);
	                }
	        		if(newval>1000){
	        			newval = 1000;
	        		}
	        		$(this).val(newval);
	                $(".score").text(newval);
	                if(newval!="" && newval!=0){
	                	$(".score-box").css("opacity","1");
	                	$(".send-score").css("opacity","1");
	                	flag = 1;
	                	var poundageMoney = calc(newval,"*",0.05,2);
                		$(".poundage-money").text(poundageMoney);
                		$(".poundage-txt").css("display","inline");
	                	
	                }else{
	                	$(".poundage-txt").css("display","inline");
	                	$(".poundage-money").text("");
	                	flag = 0;
	                	$(".score-box").css("opacity","0.5");
	                	$(".send-score").css("opacity","0.5");
	                }
	                if(newval!="" && newval!=0 && $("#num").val()!=0 && $("#num").val()!=""){
	                	calcMinScore();
	                }
	        	});
	        	
	        	$("#num").on("input propertychange",function(){
	        		var val = $(this).val();
	        		if(val==""){
	        			$(".tips-toptips").css("display","none");
	        		}
	                val = val.toString();
	                var newval = val.replace(/[^\d]/g, "");
	        		if(newval.length>3){
	    				newval = newval.substring(0,newval.length-1);
	    			}
	        		
	        		if (newval.length > 1 && newval.substring(0, 1) == 0 && newval.substring(1, 2) != ".") {
	                    newval = newval.substring(1, newval.length);
	                }
	        		if(newval>200){
	        			newval = 200;
	        		}
	        		$(this).val(newval);
	        		if(newval!="" && newval!=0 && $("#score").val()!=0 && $("#score").val()!=""){
	                	calcMinScore();
	                }
	        	});
	        	$("#memo").on("input propertychange",function(){
	        		var val = $(this).val();
	        		if(val.length>25){
	        			val = val.substring(0,25);
	        		}
	        		$(this).val(val);
	        	});
	        		
	        	
			})
		</script>
	</body>
</html>
